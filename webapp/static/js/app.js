function logRequest(reqUrl, response) {
  console.log(reqUrl, response);
  return response;
}

function onFetchResultsError(reqUrl, error) {
  console.error(reqUrl, error);
  return []; // return empty array on error
}

function showAjaxLoader() {
  var $img = document.getElementById('ajax-loader');
  $img.style.display = 'block';
}

function hideAjaxLoader() {
  var $img = document.getElementById('ajax-loader');
  $img.style.display = 'none';
}

function fetchResults(url) {
  showAjaxLoader();
  // http://lhorie.github.io/mithril/web-services.html
  return m.request({
    url: url,
    initialValue: [],
    unwrapSuccess: function (response) {
      return response.data;
    },
    unwrapError: function (response) {
      return response.error;
    }
  }).then(logRequest.bind(this, url))
    .then(function(data) { hideAjaxLoader(); return data; })
    .catch(function(data) { hideAjaxLoader(); return data; })
    .catch(onFetchResultsError.bind(this, url));
}

function paliStartsWith(searchTerms) {
  var url = "/api/pali/starts_with/" + searchTerms;
  return fetchResults(url);
}

function paliContains(searchTerms) {
  var url = "/api/pali/contains/" + searchTerms;
  return fetchResults(url);
}

function myanmarContains(searchTerms) {
  var url = "/api/myanmar/contains/" + searchTerms;
  return fetchResults(url);
}

function scrollTo(element, to, duration) {
  if (duration < 0) return;
  var difference = to - element.scrollTop;
  var perTick = difference / duration * 25;

  setTimeout(function() {
    element.scrollTop = element.scrollTop + perTick;
    if (element.scrollTop === to) return;
    scrollTo(element, to, duration - 25);
  }, 25);
}

var App = {

  controller: function (args) {
    // these are getter-setter function generated by m.prop
    var pageTitle = m.prop("ပါဠိ မြန်မာ အဘိဓာန်");
    var searchTerms = m.prop('');
    var searchPlaceholder = m.prop('Search ...');
    var searchButtonText = m.prop('ရှာ');
    var searchOption = m.prop('paliStartsWith');
    var searchResults = m.prop(null);
    var keysLayout = m.prop(MY_KEYS_LAYOUT);
    var showEn = m.prop(false);
    var showPh = m.prop(false);

    function scrollToSearchBox() {
      var $searchBox = document.getElementById('search-box');
      scrollTo(document.body, $searchBox.offsetTop, 250);
    }

    function scrollToResults() {
      var $searchBox = document.getElementById('search-box');
      $searchBox.blur();
      var $results = document.getElementById('search-results');
      scrollTo(document.body, $results.offsetTop, 250);
    }

    function handleKeyPress(key) {
      var $searchBox = document.getElementById('search-box');
      var selection = window.getSelection();
      // var selectedText = selection.toString();
      var text = $searchBox.value;

      if ($searchBox.selectionStart || $searchBox.selectionStart == '0') {
        var start = $searchBox.selectionStart;
        var end = $searchBox.selectionEnd;
        var cur = start;
        text = text.substring(0, start) + key + text.substring(end, text.length);
        cur = cur + key.length;
        $searchBox.selectionStart = cur;
        $searchBox.selectionEnd = cur;
      } else {
        text = text + key;
      }

      searchTerms(text);
      $searchBox.value = text;
      $searchBox.focus();
      $searchBox.blur();
      scrollToSearchBox();
    }

    function handleSearch(terms) {
      searchTerms(terms);
      switch (searchOption()) {
        case 'paliStartsWith':
          paliStartsWith(terms).then(searchResults).then(scrollToResults);
          break;
      }
    }

    function handleClearSearch() {
      var $searchBox = document.getElementById('search-box');
      searchTerms('');
      $searchBox.focus();
      scrollToSearchBox();
    }

    function handleSearchOptionChanged(option) {
      searchOption(option);
    }

    return {
      pageTitle: pageTitle,
      searchTerms: searchTerms,
      searchPlaceholder: searchPlaceholder,
      searchButtonText: searchButtonText,
      searchOption: searchOption,
      searchResults: searchResults,
      keysLayout: keysLayout,
      showEn: showEn,
      showPh: showPh,
      onKeyPress: handleKeyPress,
      onSearch: handleSearch,
      onClearSearch: handleClearSearch,
      onSearchOptionChanged: handleSearchOptionChanged,
    }
  },

  view: function (ctrl) {
    return m(".container", [
      m("h1.title.my", ctrl.pageTitle()),
      m.component(SearchForm, {
        searchTerms: ctrl.searchTerms,
        searchPlaceholder: ctrl.searchPlaceholder,
        searchButtonText: ctrl.searchButtonText,
        onSearch: ctrl.onSearch,
        onClearSearch: ctrl.onClearSearch,
        onSearchOptionChanged: ctrl.onSearchOptionChanged
      }),
      m.component(MyanmarKeyboard, {
        // pass the value to the component
        keysLayout: ctrl.keysLayout,
        showEn: ctrl.showEn,
        showPh: ctrl.showPh,
        onKeyPress: ctrl.onKeyPress,
      }),
      m.component(SearchResults, {
        searchTerms: ctrl.searchTerms,
        searchResults: ctrl.searchResults
      }),
    ]);
  }
};

var SearchForm = {
  controller: function (args) {
    return {
      searchPlaceholder: args.searchPlaceholder,
      searchTerms: args.searchTerms,
      searchButtonText: args.searchButtonText,
      onClearSearch: args.onClearSearch,
      onSearch: args.onSearch,
    }
  },

  view: function (ctrl) {
    return m("form.search-wrapper", [
      m('.search-box-wrapper', [
        m("input#search-box.my[type=search]", {
          placeholder: ctrl.searchPlaceholder(),
          autocomplete: 'off',
          autocapitalize: 'off',
          autofocus: true,
          required: true,
          oninput: m.withAttr('value', ctrl.searchTerms),
          value: ctrl.searchTerms()
        }),
        ctrl.searchTerms() ?
          m("button.clear-search-icon.my[type=button]", {
              onclick: ctrl.onClearSearch
            },
            'x')
          :
          null
        ,
        m("button.search-btn.my[type=button]", {
            onclick: function () {
              ctrl.onSearch(ctrl.searchTerms());
            }
          },
          ctrl.searchButtonText()),
        m('img#ajax-loader', {class: 'hide', src: 'static/images/ajax-loader.gif'}),
      ]),
    ]);
  }
};

var MyanmarKeyboard = {
  controller: function (args) {
    return {
      keysLayout: args.keysLayout,
      showEn: args.showEn,
      showPh: args.showPh,
      onKeyPress: args.onKeyPress,
    }
  },
  keygroupView: function (keygroup, showEn, showPh, onKeyPress) {
    return m('ul.nwm-keygroup', [
      keygroup.map(function (k) {
        return k.my ?
          m('li.nwm-key', [
            showPh ? m('.nwm-ph', k.ph  || m.trust('&nbsp;')) : undefined,
            m('input.nwm-my[type=button]', {value: k.my, onclick: onKeyPress.bind(this, k.my)}),
            showEn ? m('.nwm-en', k.en || m.trust('&nbsp;')) : undefined,
          ])
          :
          m('li.nwm-key.nwm-key-blank', [
            showPh ? m('.nwm-ph', m.trust('&nbsp;')) : undefined,
            m('input.nwm-my[type=button]', {value: '-'}),
            showEn ? m('.nwm-en', m.trust('&nbsp;')) : undefined,
          ])
      })
    ])
  },
  view: function (ctrl) {
    var self = this;

    return m('.nwm-container', [
      m('.nwm-left', [
        ctrl.keysLayout().left.map(function (keygroup) {
          return self.keygroupView(keygroup, ctrl.showEn(), ctrl.showPh(), ctrl.onKeyPress);
        })
      ]),
      (ctrl.keysLayout().middle ?
        m('.nwm-middle', [
          ctrl.keysLayout().middle.map(function (keygroup) {
            return self.keygroupView(keygroup, ctrl.showEn(), ctrl.showPh(), ctrl.onKeyPress);
          })
        ])
        :
        undefined),
      (ctrl.keysLayout().right ?
        m('.nwm-right', [
          ctrl.keysLayout().right.map(function (keygroup) {
            return self.keygroupView(keygroup, ctrl.showEn(), ctrl.showPh(), ctrl.onKeyPress);
          })
        ])
        :
        undefined),
    ])
  }
};

var SearchResults = {

  controller: function (args) {
    return {
      searchResults: args.searchResults,
      searchTerms: args.searchTerms,
    }
  },
  view: function (ctrl) {
    var didSearch = ctrl.searchResults() != null;

    var list = [];
    if (didSearch) {
      list = ctrl.searchResults().map(function (entry) {
        return list.concat([
          m("dt.term.my", [entry.pali]),
          m("dd.definition.my", [entry.mm])
        ]);
      });
    }

    return m(".row.search-results", {id: 'search-results'}, [
      list.length > 0 ? m("dl", list) : m('.not-found', didSearch && list.length == 0 ? 'No entry found!' : '')
    ]);
  }
};

var MY_KEYS_LAYOUT = {
  left: [[
    {en: "ka",  my: "က"},
    {en: "kha", my: "ခ"},
    {en: "ga",  my: "ဂ"},
    {en: "gha", my: "ဃ"},
    {en: "nga", my: "င"},
  ], [
    {en: "ca",  my: "စ"},
    {en: "cha", my: "ဆ"},
    {en: "ja",  my: "ဇ"},
    {en: "jha", my: "ဈ"},
    {en: "na",  my: "ဉ", ph: "ña"},
    {en: "Na",  my: "ည", ph: "Ña"},
  ], [
    {en: "Ta",  my: "ဋ", ph: "Ṭa"},
    {en: "Tha", my: "ဌ", ph: "Ṭha"},
    {en: "Da",  my: "ဍ", ph: "Ḍa"},
    {en: "Dha", my: "ဎ", ph: "Ḍha"},
    {en: "Na",  my: "ဏ", ph: "Ṇa"},
  ], [
    {en: "ta",  my: "တ"},
    {en: "tha", my: "ထ"},
    {en: "da",  my: "ဒ"},
    {en: "dha", my: "ဓ"},
    {en: "na",  my: "န"},
  ], [
    {en: "pa",  my: "ပ"},
    {en: "pha", my: "ဖ"},
    {en: "ba",  my: "ဗ"},
    {en: "bha", my: "ဘ"},
    {en: "ma",  my: "မ"},
  ], [
    {en: "ya",  my: "ယ"},
    {en: "ra",  my: "ရ"},
    {en: "la",  my: "လ"},
    {en: "La",  my: "ဠ"},
    {en: "wa",  my: "ဝ"},
    {en: "ha",  my: "ဟ"},
    {en: "sa",  my: "သ"},
  ], [
    {en: "Ya",  my: "ျ"},
    {en: "Ra",  my: "ြ"},
    {},
    {},
    {en: "Wa",  my: "ွ"},
    {en: "Ha",  my: "ှ"},
    {en: "Sa",  my: "ဿ"},
  ],
  ],
  middle: [[
    {en: "v",   my: "္", des: "virama"},
  ],
  ],
  right: [[
    {},
    {en: 'a',   my: "အ", ph: "ā"},
    {en: "i",   my: "ဣ"},
    {en: 'ii',  my: "ဤ", ph: "ī", des: "long vowel of ဣ"},
    {en: "u",   my: "ဥ"},
    {en: 'uu',  my: "ဦ", ph: "ū", des: "long vowel of ဥ"},
  ], [
    {en: "A",   my: "ါ"},
    {en: "AA",  my: "ာ"},
    {en: "I",   my: "ိ"},
    {en: "II",  my: "ီ"},
    {en: "U",   my: "ု"},
    {en: "UU",  my: "ူ"},
  ], [
    {en: "ee",  my: "ေ"},
    {en: "e",   my: "ဧ"},
    {en: "o",   my: "ဩ"},
    {en: "oo",  my: "ဪ"},
    {en: "ai",  my: "ဲ"},
  ], [
    {en: "Nga", my: "င်္"},
    {en: "M",   my: "ံ", des: "anusvara"},
    {en: ".",   my: "့"},
    {en: ":",   my: "း", des: "visarga"},
    {},
    {en: ";",   my: "်"},
  ], [
    {en: "x",   my: "၊"},
    {en: "xx",  my: "။"},
    {en: "lo",  my: "၌"},
    {en: "g",   my: "၍"},
    {en: "gg",  my: "၎"},
    {en: "ge",  my: "၏"},
  ], [
    {en: "1",   my: "၁"},
    {en: "2",   my: "၂"},
    {en: "3",   my: "၃"},
    {en: "4",   my: "၄"},
    {en: "5",   my: "၅"},
  ], [
    {en: "6",   my: "၆"},
    {en: "7",   my: "၇"},
    {en: "8",   my: "၈"},
    {en: "9",   my: "၉"},
    {en: "0",   my: "၀"},
  ],
  ]
};

m.module(document.body, App);


// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map
Array.prototype.map||(Array.prototype.map=function(r,t){var n,o,e;if(null==this)throw new TypeError(" this is null or not defined");var i=Object(this),a=i.length>>>0;if("function"!=typeof r)throw new TypeError(r+" is not a function");for(arguments.length>1&&(n=t),o=Array(a),e=0;a>e;){var p,f;e in i&&(p=i[e],f=r.call(n,p,e,i),o[e]=f),e++}return o});